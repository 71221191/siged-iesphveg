<!-- gestion/templates/gestion/base.html -->
{% load static %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Título dinámico -->
    <title>{% block title %}SGD IESP HVEG{% endblock %}</title>
    <!-- Integración de Bootstrap 5 (CSS) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- AÑADE ESTA LÍNEA PARA LOS ÍCONOS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        /* Pequeños ajustes personales */
        body {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body>

<!-- BARRA DE NAVEGACIÓN RESPONSIVA (Siempre visible) -->
    <!-- Usamos 'navbar-expand' (sin -lg) para que nunca intente colapsar -->
    <nav class="navbar navbar-expand navbar-light bg-white border-bottom shadow-sm sticky-top" style="min-height: 70px;">
        <div class="container-fluid px-3 px-md-4">
            
            <!-- 1. LOGO E IDENTIDAD -->
            <a class="navbar-brand d-flex align-items-center gap-2 me-auto" href="{% url 'lista_documentos' %}">
                <img src="{% static 'gestion/images/logo_iesp_hveg.png' %}" alt="Logo" width="35" height="40" class="d-inline-block align-text-top" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                <i class="bi bi-files-alt text-primary fs-2" style="display:none;"></i>
                
                <div style="line-height: 1.1;">
                    <span class="d-block fw-bold text-primary" style="letter-spacing: 0.5px;">SIGED - IESP HVEG</span>
                    <span class="d-block text-muted text-uppercase"
                        style="font-size: 0.65rem; letter-spacing: 0.05px;">Sistema de Gestión Documentaria</span>
                </div>
            </a>

            <!-- 2. MENÚ DERECHO (Siempre horizontal) -->
            <ul class="navbar-nav flex-row align-items-center gap-2 gap-md-3">

                {% if user.is_authenticated %}
                    
                    <!-- NOTIFICACIONES -->
                    <li class="nav-item dropdown">
                        <a class="nav-link position-relative btn btn-light border-0 rounded-circle d-flex justify-content-center align-items-center p-0" 
                           href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                           style="width: 40px; height: 40px; background-color: #f8f9fa;">
                            
                            <i class="bi bi-bell-fill text-secondary fs-5"></i>
                            
                            {% if notificaciones_no_leidas_count > 0 %}
                                <span class="position-absolute top-0 start-100 translate-middle badge border border-light rounded-circle bg-danger p-1">
                                    <span class="visually-hidden">mensajes</span>
                                </span>
                            {% endif %}
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 position-absolute" aria-labelledby="notifDropdown" style="width: 300px; right: 0;">
                            <li class="px-3 py-2 border-bottom bg-light">
                                <h6 class="mb-0 fw-bold text-primary">Notificaciones</h6>
                            </li>
                            <div class="scrollable-menu" style="max-height: 300px; overflow-y: auto;">
                                {% for notif in notificaciones_recientes %}
                                    <li>
                                        <a class="dropdown-item py-2 text-wrap border-bottom" href="{{ notif.enlace }}">
                                            <div class="d-flex align-items-start">
                                                <div class="me-2 mt-1">
                                                    {% if not notif.leida %}
                                                        <i class="bi bi-circle-fill text-primary" style="font-size: 8px;"></i>
                                                    {% else %}
                                                        <i class="bi bi-check2 text-muted"></i>
                                                    {% endif %}
                                                </div>
                                                <div>
                                                    <p class="mb-0 small {% if not notif.leida %}fw-bold text-dark{% else %}text-muted{% endif %}">
                                                        {{ notif.mensaje }}
                                                    </p>
                                                    <span class="text-secondary" style="font-size: 0.7rem;">hace {{ notif.fecha_creacion|timesince }}</span>
                                                </div>
                                            </div>
                                        </a>
                                    </li>
                                {% empty %}
                                    <li class="px-3 py-4 text-center text-muted small">Sin novedades</li>
                                {% endfor %}
                            </div>
                            <li><a class="dropdown-item text-center text-primary fw-bold py-2 small bg-light" href="{% url 'listar_notificaciones' %}">Ver todas</a></li>
                        </ul>
                    </li>

                    <!-- SEPARADOR (Solo PC) -->
                    <div class="vr h-50 mx-1 text-secondary d-none d-md-block"></div>

                    <!-- PERFIL DE USUARIO -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center gap-2 p-1 pe-0 pe-md-3 rounded-pill hover-bg-light" 
                           href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false"
                           style="border: 1px solid transparent;">
                            
                            <!-- Avatar (Visible siempre) -->
                            <div class="bg-primary text-white rounded-circle d-flex justify-content-center align-items-center shadow-sm" 
                                 style="width: 35px; height: 35px; font-weight: bold; font-size: 1rem;">
                                {% if user.perfilusuario.foto %}
                                    <img src="{{ user.perfilusuario.foto.url }}" class="rounded-circle w-100 h-100" style="object-fit: cover;">
                                {% else %}
                                    {{ user.username|slice:":1"|upper }}
                                {% endif %}
                            </div>
                            
                            <!-- Texto (Oculto en Móvil para ahorrar espacio) -->
                            <div class="d-none d-md-block text-start" style="line-height: 1.2;">
                                <span class="d-block fw-bold text-dark" style="font-size: 0.85rem; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    {{ user.first_name|default:user.username|title }}
                                </span>
                                <span class="d-block text-muted" style="font-size: 0.65rem;">
                                    {{ user.perfilusuario.rol.nombre|default:"Usuario" }}
                                </span>
                            </div>
                        </a>

                        <ul class="dropdown-menu dropdown-menu-end shadow border-0 mt-2" aria-labelledby="userDropdown">
                            <li><h6 class="dropdown-header">Mi Cuenta</h6></li>
                            <li><a class="dropdown-item" href="{% url 'perfil_usuario' %}"><i class="bi bi-person-gear me-2"></i> Mi Perfil</a></li>
                            <li><a class="dropdown-item" href="{% url 'reportes_dashboard' %}"><i class="bi bi-bar-chart-line me-2"></i> Reportes</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form action="{% url 'logout' %}" method="post" class="d-inline w-100">
                                    {% csrf_token %}
                                    <button type="submit" class="dropdown-item text-danger"><i class="bi bi-box-arrow-right me-2"></i> Cerrar Sesión</button>
                                </form>
                            </li>
                        </ul>
                    </li>

                {% else %}
                    <!-- Login -->
                    <li class="nav-item">
                        <a class="btn btn-primary btn-sm px-3 rounded-pill fw-bold" href="{% url 'login' %}">Ingresar</a>
                    </li>
                {% endif %}

            </ul>
        </div>
    </nav>

    <!-- Contenedor Principal -->
    <main class="container mt-4">
        {% block content %}
        {# El contenido de las páginas hijas irá aquí #}
        {% endblock %}
    </main>

    <!-- PIE DE PÁGINA PERSONALIZADO -->
    <footer class="text-center text-muted mt-5 py-4 border-top bg-white">
        <div class="container">
            <p class="mb-1 fw-bold">Sistema de Gestión Documentaria - IESP "Hno. Victorino Elorz Goicoechea"</p>
            <p class="small mb-0">
                Desarrollado por <span class="text-primary">Anderson Dietrich García Chilón</span> &copy; 2025<br>
                Tesis para optar el Título Profesional
            </p>
        </div>
    </footer>

    <!-- SONIDO DE NOTIFICACIÓN -->
    <!-- Asegúrate de tener el archivo en static/gestion/sounds/notification.mp3 -->
    <audio id="audioNotificacion" preload="auto">
        <source src="{% static 'gestion/sounds/notification.mp3' %}" type="audio/mpeg">
    </audio>


    <!-- INICIO DEL NUEVO SCRIPT DE NOTIFICACIONES -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- VARIABLES ---
            const audio = document.getElementById('audioNotificacion');
            const notifDropdown = document.getElementById('notifDropdown');
            // Buscamos el badge dentro del dropdown (puede que no exista si count es 0)
            let badge = notifDropdown ? notifDropdown.querySelector('.badge') : null;
            
            // Valor inicial al cargar la página (viene de Django)
            let currentCount = parseInt("{{ notificaciones_no_leidas_count|default:0 }}");
            
            // Guardamos estado inicial
            localStorage.setItem('notifCount', currentCount);

            // --- FUNCIÓN SONIDO ---
            function sonar() {
                if (audio) {
                    audio.volume = 0.5;
                    audio.play().catch(e => console.log("Audio bloqueado por navegador (falta interacción)"));
                }
            }

            // --- EL RADAR (POLLING) CADA 5 SEGUNDOS ---
            setInterval(() => {
                fetch("{% url 'api_check_notificaciones' %}")
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const nuevaCantidad = data.count;
                        
                        // SI AUMENTARON LAS NOTIFICACIONES...
                        if (nuevaCantidad > currentCount) {
                            console.log("¡Correo! Nueva notificación.");
                            
                            // 1. Sonar
                            sonar();
                            
                            // 2. Actualizar visualmente el globito rojo sin recargar
                            if (badge) {
                                badge.innerText = nuevaCantidad;
                                badge.style.display = 'inline-block';
                            } else {
                                // Si no había globito, recargamos suavemente para que aparezca la estructura
                                // OJO: Esto solo pasará la primera vez que recibas una notif estando en 0
                                location.reload(); 
                            }
                        }
                        // Actualizamos la memoria
                        currentCount = nuevaCantidad;
                        localStorage.setItem('notifCount', currentCount);
                    }
                })
                .catch(err => console.error("Silencio en la red..."));
            }, 5000); // <--- 5000 milisegundos = 5 SEGUNDOS (Lo ideal)


            // --- MARCAR COMO LEÍDAS ---
            if (notifDropdown) {
                notifDropdown.addEventListener('show.bs.dropdown', function () {
                    // Solo llamamos al servidor si hay algo que leer
                    if (currentCount > 0) {
                        fetch("{% url 'marcar_leidas' %}", {
                            method: 'POST',
                            headers: { 
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            }
                        }).then(r => r.json()).then(d => {
                            if (d.status === 'success') {
                                if(badge) badge.style.display = 'none';
                                currentCount = 0;
                                localStorage.setItem('notifCount', 0);
                            }
                        });
                    }
                });
            }

            // --- AUTO-CERRAR ALERTAS ---
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                setTimeout(() => {
                    alert.classList.add('fade');
                    setTimeout(() => alert.remove(), 500);
                }, 10000);
            });
        });
    </script>
</body>

</html>